`12페이지`

안녕하세요 LIE,Mafia Backend 발표를 맡은 김동익입니다.

백엔드 발표로는 백엔드에서 사용한 기술과 설계 내용, 그리고 구현하며 발생한 문제를 해결한 부분을 중점으로 설명드리겠습니다.

`13페이지`
백엔드에서는 젠킨스와 도커를 사용하여 AWS 환경에 배포하였고 NGINX를 통한 프론트 배포도 함께 진행했습니다. 화상회의를 위해 쿠렌토와 웹소캣을 이용하고 개발 진행에는 Spring Boot, Redis, Kafka를 사용했습니다.

`14페이지`
저희는 마이크로서비스 아키텍쳐로 설계했습니다. 마이크로서비스는 미디어를 담당하는 쿠렌토 미디어 서버, 유저의 접속 관리를 담당하는 Connection Status Server, 게임의 진행과 흐름을 담당하는 Game Logic Server, 채팅을 담당하는 Chat Server로 구성되어 있으며 메세지 브로커로 Kafka를 사용합니다.

이렇게  분리된 MicroService들은 Kafka Message Broker를 중개자로 Client와 서로 다른 Server에서 발생된 이벤트를 필요에 따라 publish, subscribe 하며 진행됩니다.

처음 설계에는 클라이언트에서 요청이 들어올 경우 각각의 서버에 직접 보내는 것이 아닌 클라이언트의 요청에 맞는 service를 처리하는 서버로 요청을 Routing해주는 API Gateway 를 사용하고, 해당 Microservice의 위치정보를 갖는 유레카 서버를  배치했습니다. 이후 설계에서는  Websocket Interface로 변경하여 사용하게 되었습니다.

`15페이지`
이렇게 백엔드 설계에 핵심이 되는 내용들을 사용한 이유에 대해 말씀드리겠습니다.
첫 번째로 마이크로서비스 아키텍쳐입니다. LIE,Mafia 가 제공해야 할 서비스를 미디어, 사용자 관리, 게임, 채팅으로 분리한 것에 근거하여 미디어서버, user connection server, game logic server, chat server로 마이크로서비스를 분리했습니다.

두 번째로 웹소캣 인터페이스 입니다. 웹소캣인터페이스를 도입함으로써 4개의 마이크로서비스에 client가 각각 요청을 보내 Websocket 통신을 유지하는 것이 아닌 Websocket Interface를 통해 통신하도록 구성했습니다.

세번째로 Redis입니다. Connection, Gamew, Chat 서버는 각각의 고유한 Redis DB를 갖도록 구성했습니다.

네번째로는 kafka입니다. Kafka는 서로 다른 Microservice들의 데이터 동기화와 발생하는 이벤트에 대한 처리를 위한 MEssage Broker로 구축되엇습니다.

`16페이지`
앞서 말씀드린 Websocket Interface로 설계를 변경한 이유에 대해 조금더 자세히 설명드리도록 하겟씁니다.

저희는 설계시  API Gateway를 도입함으로써 요청에 해당하는 Microservice로 Routing 및 로드밸런싱의 효과를 기대했습니다.

API Gateway를 통해 각 Microservice 로 보내지는 클라이언트 요청이 하나의 웹소캣 세션을 공유하여 통신해야 하지만 실제 Gateway를 구축하여 사용했을 땐 사용자를 기억하는 것이 아닌 단순 Routing 효과만 볼 수 있었습니다

이에 문제를 느끼고 API gateway 와 Eureka Server를 사용하는 방식에서 Websocket 통신을 담당하는 Websocket Interface 로 설계를 변경했습니다.

모든 사용자의 소캣 통신은 Websocket Interface를 통해 연결됩니다. 

Websocet Interface를 통해 Websocket Session을 유지하며, 요청에 맞는 service를 처리하는 Microservice로 보내줄 수 있게 되었습니다.

`17페이지`
다음으로는 Kafka Message Broker를 도입하면서 적용한 헥사고날 아키텍쳐입니다. 육각형 패턴이라고 알려져 있는 헥사고날 아키텍쳐는 포트와 어댑터를 사용합니다.

{

포트는 내부 비즈니스 영역을 외부 영역에 노출한 API 로 인 바운드 포트와 아웃바운드포트로 구분되어 있습니다.

인바운드 포트는 내부 영역 사용을 위해 노출된 API입니다.
아웃 바운드 포트는 내부영역이 외부 영역을 사용하기 위한 API입니다.

() 어댑터는 외부세계와 포트간 교환을 조정합니다. 마찬가지로 인바운드 어댑터와 아웃바운드 어댑터로 구분됩니다.

인바운드 어댑터는 외부 애플리케이션/서비스와 내부 비즈니스영역간 데이터 교환을 조정합니다. 아웃바운드 어댑터는 내부 비즈니스 영역과 외부 애플리케이션/서비스 간 데이터 교환을 조정합니다.

}//생략 가능

헥사고날 아키텍쳐를 도입함으로써 비즈니스 로직이 표현 로직이나 데이터 접근 로직에 의존하지 않는 효과를 볼 수 있었습니다.

`18페이지`
다음으로 CI/CD에 대해 설명드리도록 하겠습니다.

저희는 git 을 Jenkins과 연동해서 Build 자동화를 진행 하였고 Image를 docker hub에 push를 진행하였습니다.

AWS에서 image pull을 받아서 container에서 실행, 배포하고 있습니다.

`19페이지`
다음으로는 여러가지 발생했던 문제들 중 가장 고민했던 문제와 문제를 해결한 과정에 대해 설명드리겠습니다.

`20페이지`
우선 저희가 가장 고민했던 문제들은 아까 말씀드린 웹소캣인터페이스와 헥사고날 아키텍쳐 카프카 메세지 브로커가 있습니다. 앞서 간략히 설명드렸던 부분은 생략하고 이번 챕터에서는 Event-Driven Architecture와 Kafka의 이벤트 Produce,Consume 내용, Timer Task, 사용자 이탈 처리에 대해 설명드리겠습니다.

`21페이지`
게임이 일어나는 각각의 방들은 생성된 시점부터 소멸되는 시점까지 흐름별로 고유한 Start Time과 End Time 갖고 진행됩니다.
게임의 단계별로 Event를 발생시켜 특정 Game Room안에 모든 속하는 모든 클라이언트들은 동일한 게임 흐름을 진행해야 합니다.

이러한 요구사항에 맞춰 Thred Safe한 게임 흐름을 진행하기 위해 Timer Task를 적용했습니다. Timer Task의 schedule 함수를 이용하여 게임의 단계별로 수행해야 할 Task와 Time을 부여하고 단계별로 지정된 시간에 맞춰 task 를 수행할 수 있도록 구현했습니다.

`22페이지`
다음으로 Event-Drive 아키텍쳐와 Kafka에 대해 설명드리겠습니다. 이벤트 드리븐 아키텍쳐란 이벤트 혹은 중요 비즈니스 순간을 감지하고 실시간으르ㅗ 처리할 수 있도록 하는 소프트웨어 디자인 패턴입니다. 요청 시에 응답을 기다리는 것이 아닌 이벤트에 의해 실행되는 비동기 형태를 갖을 수 있습니다.

여러 개의 이벤트를 가지고 있는 마피아 게임에서 각각 발생하는 Event를 바탕으로 전체 서비스의 상태가 동기화 되어야 하며 유기적으로 수행되어야 하므로 Event-Driven 아키텍쳐를 도입하게 되었습니다.


각각의 서버에서 처리되어야 할 이벤트를 토픽으로 지정하고 외부에 필요한 이벤트를 생성하며 서버의 상태, 데이터 교환을 카프카 메세지 브로커를 중개자로 유기적으로 동작하도록 구현했습니다. 

저희 서비스의 서버별 Produce 이벤트와 Consume 이벤트는 다음과 같습니다.

`23페이지`
마지막으로 비정상적인 사용자 이탈처리입니다.
정상적으로 방나가기를 클릭한 것이 아닌 일시적인 오류로 비정상 이탈시 세션을 관리하는 방법으로, 40초마다 PING Test를 하도록 스케줄러를 적용하여 Heath Check 할수 있도록 구현했습니다

Heath Check는 다음과 같은 단계로 수행됩니다.
먼저 등록된 스케줄에 맞춰 40초마다 서버에서 관리되는 모든 세션에게 PING TEst를 보냅니다.

그후 TEST에 답변이 오지 않을 경우 비정상 이탈 세션으로 분류됩니다.
분류된 비정상 이탈 세션은 Timer Task를 재할당하여 40초 후 PING TEST를 재시도 합니다.

재시도 한 PING TEST에서도 실패할 경우 완전 이탈한 것으로 간주하고 해당 세션을 종료합니다.성공할 경우에는 재입장 처리가 됩니다. 하지만 일정 시간 이상 게임에 참여를 안하고 잇을 경우 투표 등 게임 진행에 문제가 될 수 있으므로 해당 게임 동안은 사망자 처리가 되고, 이후 다시 시작된 게임에서는 정상 참여가 가능합니다.




`마무리 멘트`
"" 여기에 MVP 배포를 우선적으로 생각하여 채팅 서버는 차후 구현 예정에 있습니다. ""
이상으로 LIE Mafia 발표를 마치고, 프로젝트 시연을 진행하겠습니다.
